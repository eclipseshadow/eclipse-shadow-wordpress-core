!function(a){var b={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",prePopulate:null,processPrePopulate:!1,idPrefix:"token-input-",resultsFormatter:function(a){return"<li>"+a[this.propertyToSearch]+"</li>"},tokenFormatter:function(a){return"<li><p>"+a[this.propertyToSearch]+"</p></li>"},onResult:null,onAdd:null,onDelete:null,onReady:null},c={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},d={BEFORE:0,AFTER:1,END:2},e={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},f={init:function(c,d){var e=a.extend({},b,d||{});return this.each(function(){a(this).data("tokenInputObject",new a.TokenList(this,c,e))})},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(a){return this.data("tokenInputObject").add(a),this},remove:function(a){return this.data("tokenInputObject").remove(a),this},get:function(){return this.data("tokenInputObject").getTokens()}};a.fn.tokenInput=function(a){return f[a]?f[a].apply(this,Array.prototype.slice.call(arguments,1)):f.init.apply(this,arguments)},a.TokenList=function(b,f,g){function h(){return null!==g.tokenLimit&&G>=g.tokenLimit?(I.hide(),q(),void 0):void 0}function i(){if(E!==(E=I.val())){var a=E.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");Q.html(a),I.width(Q.width()+30)}}function j(b){var c=g.tokenFormatter(b);c=a(c).addClass(g.classes.token).insertBefore(O),a("<span>"+g.deleteText+"</span>").addClass(g.classes.tokenDelete).appendTo(c).click(function(){return o(a(this).parent()),J.change(),!1});var d={id:b.id};return d[g.propertyToSearch]=b[g.propertyToSearch],a.data(c.get(0),"tokeninput",b),F=F.slice(0,L).concat([d]).concat(F.slice(L)),L++,p(F,J),G+=1,null!==g.tokenLimit&&G>=g.tokenLimit&&(I.hide(),q()),c}function k(b){var c=g.onAdd;if(G>0&&g.preventDuplicates){var d=null;if(N.children().each(function(){var c=a(this),e=a.data(c.get(0),"tokeninput");return e&&e.id===b.id?(d=c,!1):void 0}),d)return l(d),O.insertAfter(d),I.focus(),void 0}(null==g.tokenLimit||G<g.tokenLimit)&&(j(b),h()),I.val(""),q(),a.isFunction(c)&&c.call(J,b)}function l(a){a.addClass(g.classes.selectedToken),K=a.get(0),I.val(""),q()}function m(a,b){a.removeClass(g.classes.selectedToken),K=null,b===d.BEFORE?(O.insertBefore(a),L--):b===d.AFTER?(O.insertAfter(a),L++):(O.appendTo(N),L=G),I.focus()}function n(b){var c=K;K&&m(a(K),d.END),c===b.get(0)?m(b,d.END):l(b)}function o(b){var c=a.data(b.get(0),"tokeninput"),d=g.onDelete,e=b.prevAll().length;e>L&&e--,b.remove(),K=null,I.focus(),F=F.slice(0,e).concat(F.slice(e+1)),L>e&&L--,p(F,J),G-=1,null!==g.tokenLimit&&I.show().val("").focus(),a.isFunction(d)&&d.call(J,c)}function p(b,c){var d=a.map(b,function(a){return a[g.tokenValue]});c.val(d.join(g.tokenDelimiter))}function q(){P.hide().empty(),M=null}function r(){P.css({position:"absolute",top:a(N).offset().top+a(N).outerHeight(),left:a(N).offset().left,zindex:999}).show()}function s(){g.searchingText&&(P.html("<p>"+g.searchingText+"</p>"),r())}function t(){g.hintText&&(P.html("<p>"+g.hintText+"</p>"),r())}function u(a,b){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function v(a,b,c){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","g"),u(b,c))}function w(b,c){if(c&&c.length){P.empty();var d=a("<ul>").appendTo(P).mouseover(function(b){x(a(b.target).closest("li"))}).mousedown(function(b){return k(a(b.target).closest("li").data("tokeninput")),J.change(),!1}).hide();a.each(c,function(c,e){var f=g.resultsFormatter(e);f=v(f,e[g.propertyToSearch],b),f=a(f).appendTo(d),c%2?f.addClass(g.classes.dropdownItem):f.addClass(g.classes.dropdownItem2),0===c&&x(f),a.data(f.get(0),"tokeninput",e)}),r(),g.animateDropdown?d.slideDown("fast"):d.show()}else g.noResultsText&&(P.html("<p>"+g.noResultsText+"</p>"),r())}function x(b){b&&(M&&y(a(M)),b.addClass(g.classes.selectedDropdownItem),M=b.get(0))}function y(a){a.removeClass(g.classes.selectedDropdownItem),M=null}function z(){var b=I.val().toLowerCase();b&&b.length&&(K&&m(a(K),d.AFTER),b.length>=g.minChars?(s(),clearTimeout(D),D=setTimeout(function(){A(b)},g.searchDelay)):q())}function A(b){var c=b+B(),d=H.get(c);if(d)w(b,d);else if(g.url){var e=B(),f={};if(f.data={},e.indexOf("?")>-1){var h=e.split("?");f.url=h[0];var i=h[1].split("&");a.each(i,function(a,b){var c=b.split("=");f.data[c[0]]=c[1]})}else f.url=e;f.data[g.queryParam]=b,f.type=g.method,f.dataType=g.contentType,g.crossDomain&&(f.dataType="jsonp"),f.success=function(d){a.isFunction(g.onResult)&&(d=g.onResult.call(J,d)),H.add(c,g.jsonContainer?d[g.jsonContainer]:d),I.val().toLowerCase()===b&&w(b,g.jsonContainer?d[g.jsonContainer]:d)},a.ajax(f)}else if(g.local_data){var j=a.grep(g.local_data,function(a){return a[g.propertyToSearch].toLowerCase().indexOf(b.toLowerCase())>-1});a.isFunction(g.onResult)&&(j=g.onResult.call(J,j)),H.add(c,j),w(b,j)}}function B(){var a=g.url;return"function"==typeof g.url&&(a=g.url.call()),a}if("string"===a.type(f)||"function"===a.type(f)){g.url=f;var C=B();void 0===g.crossDomain&&(g.crossDomain=-1===C.indexOf("://")?!1:location.href.split(/\/+/g)[1]!==C.split(/\/+/g)[1])}else"object"==typeof f&&(g.local_data=f);g.classes?g.classes=a.extend({},c,g.classes):g.theme?(g.classes={},a.each(c,function(a,b){g.classes[a]=b+"-"+g.theme})):g.classes=c;var D,E,F=[],G=0,H=new a.TokenList.Cache,I=a('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",g.idPrefix+b.id).focus(function(){(null===g.tokenLimit||g.tokenLimit!==G)&&t()}).blur(function(){q(),a(this).val("")}).bind("keyup keydown blur update",i).keydown(function(b){var c,f;switch(b.keyCode){case e.LEFT:case e.RIGHT:case e.UP:case e.DOWN:if(a(this).val()){var g=null;return g=b.keyCode===e.DOWN||b.keyCode===e.RIGHT?a(M).next():a(M).prev(),g.length&&x(g),!1}c=O.prev(),f=O.next(),c.length&&c.get(0)===K||f.length&&f.get(0)===K?b.keyCode===e.LEFT||b.keyCode===e.UP?m(a(K),d.BEFORE):m(a(K),d.AFTER):b.keyCode!==e.LEFT&&b.keyCode!==e.UP||!c.length?b.keyCode!==e.RIGHT&&b.keyCode!==e.DOWN||!f.length||l(a(f.get(0))):l(a(c.get(0)));break;case e.BACKSPACE:if(c=O.prev(),!a(this).val().length)return K?(o(a(K)),J.change()):c.length&&l(a(c.get(0))),!1;1===a(this).val().length?q():setTimeout(function(){z()},5);break;case e.TAB:case e.ENTER:case e.NUMPAD_ENTER:case e.COMMA:if(M)return k(a(M).data("tokeninput")),J.change(),!1;break;case e.ESCAPE:return q(),!0;default:String.fromCharCode(b.which)&&setTimeout(function(){z()},5)}}),J=a(b).hide().val("").focus(function(){I.focus()}).blur(function(){I.blur()}),K=null,L=0,M=null,N=a("<ul />").addClass(g.classes.tokenList).click(function(b){var c=a(b.target).closest("li");c&&c.get(0)&&a.data(c.get(0),"tokeninput")?n(c):(K&&m(a(K),d.END),I.focus())}).mouseover(function(b){var c=a(b.target).closest("li");c&&K!==this&&c.addClass(g.classes.highlightedToken)}).mouseout(function(b){var c=a(b.target).closest("li");c&&K!==this&&c.removeClass(g.classes.highlightedToken)}).insertBefore(J),O=a("<li />").addClass(g.classes.inputToken).appendTo(N).append(I),P=a("<div>").addClass(g.classes.dropdown).appendTo("body").hide(),Q=a("<tester/>").insertAfter(I).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:I.css("fontSize"),fontFamily:I.css("fontFamily"),fontWeight:I.css("fontWeight"),letterSpacing:I.css("letterSpacing"),whiteSpace:"nowrap"});J.val("");var R=g.prePopulate||J.data("pre");g.processPrePopulate&&a.isFunction(g.onResult)&&(R=g.onResult.call(J,R)),R&&R.length&&a.each(R,function(a,b){j(b),h()}),a.isFunction(g.onReady)&&g.onReady.call(),this.clear=function(){N.children("li").each(function(){0===a(this).children("input").length&&o(a(this))})},this.add=function(a){k(a)},this.remove=function(b){N.children("li").each(function(){if(0===a(this).children("input").length){var c=a(this).data("tokeninput"),d=!0;for(var e in b)if(b[e]!==c[e]){d=!1;break}d&&o(a(this))}})},this.getTokens=function(){return F}},a.TokenList.Cache=function(b){var c=a.extend({max_size:500},b),d={},e=0,f=function(){d={},e=0};this.add=function(a,b){e>c.max_size&&f(),d[a]||(e+=1),d[a]=b},this.get=function(a){return d[a]}}}(jQuery);